set -e

LIBS="cc ds mem"
PROGS="c cpp"

OUTLIBS=""
OUTPROGS=""

for PROG in $PROGS
do
	OUTPROGS+=" bin/$PROG"
done

echo HFILES=`ls src/*/*.h | tr "\n" " "` > Makefile
cat << EOF >> Makefile
override CFLAGS += -Isrc/ -g -Wall

all: $OUTPROGS

.PHONY: all

%.o: %.c \$(HFILES)
	\$(CC) \$(CFLAGS) -o \$@ -c $<
EOF

for LIB in $LIBS
do
	OUTLIB=src/$LIB/$LIB.a
	OUTLIBS+=" $OUTLIB"
    CFILES=`ls src/$LIB/*.c`
    OFILES=""
    for CFILE in $CFILES
    do
    	OFILES+=" src/$LIB/`basename $CFILE .c`.o"
    done
	cat << EOF >> Makefile
$OUTLIB: $OFILES
	\$(AR) rs \$@ $OFILES
EOF
done

for PROG in $PROGS
do
    CFILES=`ls src/cmd/$PROG/*.c`
    OFILES=""
    for CFILE in $CFILES
    do
    	OFILES+=" src/cmd/$PROG/`basename $CFILE .c`.o"
    done
	cat << EOF >> Makefile 
bin/$PROG: $OFILES $OUTLIBS
	mkdir -p bin
	\$(CC) $OFILES $OUTLIBS -o \$@
EOF
done


